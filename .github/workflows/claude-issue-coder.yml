name: Claude Issue Solver

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  solve-issue:
    runs-on: claude-ec2
    # Prevent the bot from triggering itself if it opens issues
    if: ${{ github.actor != 'github-actions[bot]' }}

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ISSUE_BODY: ${{ github.event.issue.body }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main  # Start from the main branch

      - name: Configure Git Identity
        run: |
          git config user.name "Claude Agent"
          git config user.email "claude-agent@users.noreply.github.com"

      - name: Create Issue Branch
        id: create-branch
        run: |
          BRANCH_NAME="feat/issue-${{ env.ISSUE_NUMBER }}"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Created and switched to branch: $BRANCH_NAME"

      - name: Run Claude Code
        id: run-claude
        # We pass the Issue Body as the prompt
        run: |
          echo "Processing Issue #${{ env.ISSUE_NUMBER }}"
          
          # Run Claude with the issue description
          # Ensure --auto-commit=false so we can control the commit below
          claude --prompt "$ISSUE_BODY" --auto-commit=false

      - name: Check for Changes
        id: git-check
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No code changes generated by Claude."
          fi

      - name: Commit and Push
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git add .
          git commit -m "feat: implement solution for issue #${{ env.ISSUE_NUMBER }}"
          git push origin ${{ steps.create-branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true'
        run: |
          gh pr create \
            --title "feat: Resolution for Issue #${{ env.ISSUE_NUMBER }}" \
            --body "This PR was automatically generated by Claude Code based on Issue #${{ env.ISSUE_NUMBER }}. Closes #${{ env.ISSUE_NUMBER }}." \
            --head ${{ steps.create-branch.outputs.branch_name }} \
            --base main
